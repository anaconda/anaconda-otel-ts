name: 'Run Integration Tests'
description: 'Runs integration tests on anaconda-opentelemetry package code'
inputs:
  node-version:
    description: 'Node version to use'
    required: true
  otel-prod-token:
    description: 'OpenTelemetry production token'
    required: true
  otel-prod-endpoint:
    description: 'OpenTelemetry production endpoint'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      shell: bash
      working-directory: .
      run: npm ci || npm install

    - name: Set up Docker
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

    - name: Start OpenTelemetry Collector
      working-directory: .
      shell: bash
      run: |
        # Create local directory with open permissions
        OUTPUT_DIR=/tmp/otel-output
        mkdir -p $OUTPUT_DIR
        chmod 757 $OUTPUT_DIR

        CONFIG_PATH="./tests/manifests/otel-collector-config.yaml"

        # Use bind mount instead of Docker volume
        docker run -d \
          --name otel-collector \
          -p 4317:4317 \
          -p 4318:4318 \
          -v "$CONFIG_PATH:/etc/otelcol/config.yaml:ro" \
          -v "$OUTPUT_DIR:/tmp/otel-output" \
          otel/opentelemetry-collector-contrib:0.129.1 \
          --config=/etc/otelcol/config.yaml

    - name: Run integration tests
      shell: bash
      working-directory: .
      run: |
        timeout 30 bash -c 'until curl -s -o /dev/null -w "%{http_code}" $ATEL_METRICS_ENDPOINT 2>/dev/null | grep -q "^[0-9]"; do sleep 1; done' && echo "OpenTelemetry Collector is up!" || echo "Timeout waiting for collector"
        npm run test:integration